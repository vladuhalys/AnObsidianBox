Метод `whenComplete()` класу `Future` в Dart використовується для виконання певної дії після завершення асинхронної операції, незалежно від того, чи була вона успішною чи завершилася помилкою. Він гарантує, що певний блок коду буде виконаний завжди після завершення `Future`, подібно до блоку `finally` в обробці винятків.

### Основна ідея методу `whenComplete()`

Метод `whenComplete()` допомагає виконати певні дії після того, як `Future` завершується, незалежно від того, чи операція успішна або виникла помилка. Цей метод часто використовують для очищення ресурсів, завершення анімацій, закриття з'єднань або інших дій, які повинні бути виконані незалежно від результату операції.

### Синтаксис методу `whenComplete()`

```dart
Future<T> whenComplete(Function action);
````

- **action** — функція або дія, яка буде виконана після завершення `Future`, незалежно від того, чи завершився він успішно, чи з помилкою. Ця функція не отримує жодних аргументів і не повертає значення.

Метод `whenComplete()` повертає новий `Future`, який містить результат або помилку початкового `Future`.

### Основні моменти

1. **Незалежність від результату**: Функція, передана в `whenComplete()`, виконується після завершення `Future`, незалежно від того, чи була операція успішною чи сталася помилка.
2. **Не замінює обробку помилок**: `whenComplete()` не перехоплює і не обробляє помилки, які виникли у початковому `Future`. Помилки, що виникли, передаються далі, і їх потрібно обробляти окремо за допомогою [[catchError()]] або через блок [[try-catch]].

### Простий приклад використання `whenComplete()`

```dart
Future<void> fetchData() async {
  await Future.delayed(Duration(seconds: 2));
  print("Дані завантажені");
}

void main() {
  fetchData().whenComplete(() {
    print("Асинхронна операція завершена");
  });
}
```

У цьому прикладі:

- Асинхронна функція `fetchData()` виконується, і після її завершення (незалежно від того, як вона завершиться), виконується функція в `whenComplete()`, яка виводить повідомлення "Асинхронна операція завершена".

### Приклад з помилкою

Якщо у `Future` виникає помилка, метод `whenComplete()` все одно виконає дію після завершення, але помилка передається далі для обробки.

```dart
Future<void> fetchDataWithError() async {
  await Future.delayed(Duration(seconds: 2));
  throw Exception("Помилка під час завантаження даних");
}

void main() {
  fetchDataWithError()
      .whenComplete(() {
        print("Очищення після завершення операції");
      })
      .catchError((error) {
        print("Обробка помилки: $error");
      });
}
```

У цьому прикладі:

- Навіть якщо в операції `fetchDataWithError()` виникає помилка, код в `whenComplete()` буде виконаний, тобто "Очищення після завершення операції" буде виведено в консоль.
- Помилка передається далі, і вона обробляється через [[catchError()]].

### Порівняння з методом `then()`

Метод `whenComplete()` часто використовується разом з методом `then()`. Основна різниця між ними в тому, що `then()` виконується лише в разі успішного завершення `Future`, тоді як `whenComplete()` виконується завжди — як при успіху, так і при помилці.

#### Приклад з [[then()]] і `whenComplete()`:

```dart
Future<void> fetchData() async {
  await Future.delayed(Duration(seconds: 2));
  print("Дані завантажені");
}

void main() {
  fetchData()
      .then((_) {
        print("Операція успішно завершена");
      })
      .whenComplete(() {
        print("Асинхронна операція завершена");
      });
}
```

У цьому прикладі:

- `then()` виконується лише в разі успішного завершення операції.
- `whenComplete()` виконується завжди, незалежно від результату.

### Приклад із завершенням операцій

Метод `whenComplete()` часто використовується для очищення або завершення ресурсів після операцій. Наприклад, після завершення операції можна закрити з'єднання або зупинити анімацію.

```dart
Future<void> performOperation() async {
  await Future.delayed(Duration(seconds: 2));
  print("Операція виконана");
}

void main() {
  performOperation()
      .whenComplete(() {
        print("Завершення операції та очищення ресурсів");
      });
}
```
### Взаємодія з помилками

Метод `whenComplete()` не обробляє помилки самостійно, але він викликається незалежно від того, чи виникла помилка в асинхронній операції. Помилка все одно передається далі для обробки, наприклад, через [[catchError()]] або через блок [[try-catch]].

```dart
Future<void> performFailingOperation() async {
  await Future.delayed(Duration(seconds: 2));
  throw Exception("Операція провалилася");
}

void main() {
  performFailingOperation()
      .whenComplete(() {
        print("Очищення ресурсів, незважаючи на помилку");
      })
      .catchError((error) {
        print("Помилка оброблена: $error");
      });
}
```

У цьому прикладі:

- Операція завершується з помилкою, але код для очищення ресурсів виконується, тому що він у методі `whenComplete()`.
- Помилка обробляється окремо за допомогою `catchError()`.

### Взаємодія з  [[async & await]]

Метод `whenComplete()` чудово поєднується з синтаксисом `async/await`. Ви можете використовувати його для чистого коду, де ресурси або будь-які завершальні дії виконуються після завершення асинхронної операції.

```dart
Future<void> performOperation() async {
  try {
    await Future.delayed(Duration(seconds: 2));
    print("Операція виконана");
  } catch (e) {
    print("Помилка: $e");
  } finally {
    print("Очищення ресурсів у блокові finally");
  }
}

void main() {
  performOperation();
}
```

У цьому прикладі блок `finally` виконує подібну роль до `whenComplete()`. Метод `whenComplete()` надає більш декларативний спосіб написання такої логіки, де потрібно виконати очищення або інші дії після завершення операції.

### Підсумки

- **`whenComplete()`** використовується для виконання дій після завершення `Future`, незалежно від того, чи завершився він успішно, чи з помилкою.
- Він гарантує, що певний код буде виконано після завершення асинхронної операції, що робить його схожим на блок `finally` в синхронному коді.
- Метод не обробляє помилки, але його дія виконується навіть у разі помилки.
- Це корисний метод для очищення ресурсів або виконання будь-яких фінальних дій після завершення операцій.

Метод `whenComplete()` забезпечує надійний спосіб виконання коду незалежно від результату операції, що робить його важливим інструментом для керування життєвим циклом асинхронних процесів у Dart.