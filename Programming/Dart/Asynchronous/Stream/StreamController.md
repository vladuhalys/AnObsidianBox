**StreamController** в Dart — це інструмент, який дозволяє створювати і керувати потоками (Streams). Він використовується для генерування подій, контролю за потоком цих подій і передачі їх підписникам. Завдяки **StreamController**, ви можете вручну додавати дані, помилки та управляти завершенням потоку.

### Основні компоненти **StreamController**:

1. **stream**:
    
    - Це властивість, що повертає потік, на який можуть підписуватися слухачі. Цей потік передає дані, які ви додаєте в контролер через його методи.
2. **sink**:
    
    - Це властивість, що надає інтерфейс для додавання подій у потік. Ви використовуєте `sink.add()` для додавання нових подій, `sink.addError()` для додавання помилок, і `sink.close()` для завершення потоку.
3. **close()**:
    
    - Викликається для завершення потоку. Після виклику цього методу події більше не можуть додаватися до потоку, і всі підписники отримають сповіщення про завершення потоку.

### Типи **StreamController**

Dart пропонує два основні типи контролерів потоків:

1. **[[Single subscription]] StreamController**:
    
    - Використовується для створення потоку з одноразовою підпискою, де лише один слухач може підписатися на потік.
    - Це типовий тип контролера, який підходить для сценаріїв, де потік даних не повинен передаватися декільком слухачам одночасно.
2. **[[Broadcast]] StreamController**:
    
    - Використовується для створення **Broadcast Stream**, що дозволяє багатьом слухачам одночасно підписуватися на потік.
    - Для цього потрібно викликати метод `StreamController.broadcast()`.

### Приклад використання **StreamController**:

#### 1. **Single Subscription StreamController**:

```dart
import 'dart:async';

void main() {
  // Створення StreamController
  StreamController<int> controller = StreamController<int>();

  // Створюємо потік та підписуємо слухача
  controller.stream.listen((data) {
    print('Отримано дані: $data');
  });

  // Додаємо події в потік
  controller.sink.add(1);
  controller.sink.add(2);
  controller.sink.add(3);

  // Закриваємо потік
  controller.close();
}
```

У цьому прикладі:

- Створено контролер потоку `StreamController<int>`.
- Дані додаються в потік через `sink.add()`.
- Після цього, коли слухач підписується на потік, він отримує всі події.

#### 2. **Broadcast StreamController**:

```dart
import 'dart:async';

void main() {
  // Створення Broadcast StreamController
  StreamController<int> controller = StreamController<int>.broadcast();

  // Перший слухач підписується
  controller.stream.listen((data) {
    print('Слухач 1 отримав: $data');
  });

  // Другий слухач підписується
  controller.stream.listen((data) {
    print('Слухач 2 отримав: $data');
  });

  // Додаємо події в потік
  controller.sink.add(1);
  controller.sink.add(2);
  controller.sink.add(3);

  // Закриваємо потік
  controller.close();
}
```

У прикладі з **Broadcast StreamController**:

- Ми створюємо потік, який може мати декількох слухачів.
- Обидва слухачі отримують ті самі події в реальному часі.

### Методи **StreamController**:

- **sink.add()**: Додає події в потік. Ці події будуть отримані всіма слухачами, які підписалися на потік.
    
    `controller.sink.add(10);  // Додає подію зі значенням 10`
    
- **sink.addError()**: Додає помилку в потік. Якщо у потоку є слухачі, вони зможуть обробити помилку через `onError`.
    
    `controller.sink.addError('Сталася помилка');`
    
- **close()**: Закриває потік. Після виклику цього методу нові події або помилки не можуть бути додані, і слухачі отримають сповіщення про завершення потоку.
    
    `controller.close();`
    

### Використання StreamController для управління асинхронними подіями

Однією з ключових переваг **StreamController** є те, що ви можете використовувати його для управління асинхронними подіями. Наприклад, ви можете надсилати події в потік через певні проміжки часу або у відповідь на дії користувача.

#### Приклад з асинхронними подіями:

```dart
import 'dart:async';

void main() {
  StreamController<int> controller = StreamController<int>();

  // Підписуємо слухача на потік
  controller.stream.listen((data) {
    print('Отримано подію: $data');
  }, onDone: () {
    print('Потік завершено');
  });

  // Асинхронно додаємо події через таймер
  Timer.periodic(Duration(seconds: 1), (Timer t) {
    controller.sink.add(t.tick);  // Додаємо події в потік щосекунди
    if (t.tick == 5) {
      controller.close();  // Закриваємо потік через 5 секунд
      t.cancel();          // Зупиняємо таймер
    }
  });
}
```

У цьому прикладі:

- Потік отримує події щосекунди завдяки таймеру.
- Після п'яти подій потік закривається, і слухач отримує повідомлення про завершення.

### Важливі моменти при використанні **StreamController**:

1. **Закриття потоку**: Завжди потрібно закривати потік після того, як всі події передані, за допомогою `controller.close()`. Якщо цього не зробити, слухачі ніколи не отримають сповіщення про завершення, що може призвести до витоків пам'яті.
    
2. **Підписка на потік**: У випадку з **Single Subscription Stream**, тільки один слухач може підписатися на потік. Якщо спробувати підписати ще одного слухача, буде згенерована помилка.
    
3. **Асинхронні потоки**: Потоки можуть бути асинхронними, і події можуть надходити в них із затримкою, як у прикладі з таймером. Це дає можливість обробляти події, які відбуваються з плином часу.
    
4. **Обробка помилок**: Якщо в потік додається помилка через `sink.addError()`, слухачі повинні бути готові обробляти ці помилки через параметр `onError` у методі `listen()`.
    

### Переваги використання **StreamController**:

- **Гнучкість**: Ви маєте повний контроль над тим, коли і які події надсилаються в потік.
- **Асинхронна обробка**: **StreamController** дозволяє легко працювати з асинхронними даними, такими як відгуки користувача або системні події.
- **Багаторазова підписка** (в випадку з **Broadcast StreamController**): Можливість мати декілька слухачів, які одночасно отримують події.

### Недоліки використання **StreamController**:

- **Необхідність ручного управління**: Ви повинні самостійно додавати події, завершувати потік і обробляти помилки.
- **Ризик витоків пам'яті**: Якщо ви забудете закрити потік або неправильно обробите підписки, це може призвести до витоків пам'яті, оскільки ресурси, пов'язані з потоком, залишаться невивільненими.

### Висновок

**StreamController** є потужним інструментом для створення та управління потоками в Dart. Він дозволяє генерувати події і передавати їх слухачам, що робить його незамінним для реалізації асинхронних операцій.