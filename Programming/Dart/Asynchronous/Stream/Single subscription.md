У Dart існує два основних типи потоків (streams): **Single Subscription Stream** (одноразова підписка) і **Broadcast Stream** (потік із багаторазовою підпискою).

> [!NOTE]
> **Single Subscription Stream** (потік з одноразовою підпискою) є найпоширенішим типом потоку, коли споживач може прослуховувати події лише один раз. Потік передає події послідовно, і кожен раз, коли на нього підписується слухач, події передаються лише цьому конкретному слухачу. Після завершення підписки або завершення потоку нових підписників приймати не можна.

### Основні характеристики Single Subscription Stream:

1. **Одноразова підписка**:
    
    - Після того, як один слухач підписується на потік, інший слухач більше не може підписатися на цей самий потік.
    - Якщо ви намагаєтеся підписатися на потік вдруге після першої підписки, буде згенерована помилка типу `StateError`.
    
1. **Лінійність**:
    - Події обробляються в лінійній послідовності. Кожна подія обробляється під час її отримання, і вони надсилаються лише одному слухачу.
    - Потік гарантує, що події будуть оброблятися одна за одною, а не одночасно.
    
1. **Одноразове відтворення подій**:
    - Дані, які надсилаються в потік, можуть бути оброблені лише один раз. Тому якщо потік вже був прослуханий, він більше не зможе передавати дані іншим слухачам.
    - Після того, як події в потоці завершені, вони не можуть бути відтворені повторно.
    
1. **Асинхронність**:
    - Як і всі потоки в Dart, Single Subscription Stream є асинхронним, тобто події надсилаються та обробляються через певний час (як правило, після того, як слухач підписується на потік).
    
1. **Типові сценарії використання**:
    - Використовується, коли у вас є джерело даних, яке потрібно обробити один раз.
    - Наприклад, потік даних із HTTP-запиту або потік, який працює з файлами, де події (дані) відправляються один раз і обробляються одним слухачем.

### Як працює Single Subscription Stream?

Потік подій починає передавати дані, коли на нього підписується слухач (listener). Як тільки слухач починає слухати, всі події потоку надходять до нього одна за одною. Після завершення потоку або при виникненні помилки слухач отримує відповідне сповіщення.

#### Простий приклад:

```dart
void main() {
  // Створюємо потік (Single Subscription Stream)
  Stream<int> singleStream = Stream.fromIterable([1, 2, 3, 4, 5]);

  // Підписуємося на потік
  singleStream.listen((data) {
    print('Отримано дані: $data');
  }, onDone: () {
    print('Потік завершено');
  });
}
```

У цьому прикладі:

- Ми створюємо потік, який передає послідовність чисел від 1 до 5.
- Потім підписуємося на потік через метод `listen()`.
- Дані передаються слухачу по черзі, а після того, як усі дані передані, викликається `onDone()` для сповіщення про завершення потоку.

---
### Підписка на події

Для того, щоб отримувати події з Single Subscription Stream, ви використовуєте метод `listen()`. Цей метод дозволяє підписатися на потік і визначити, як саме слід обробляти події, які надходять із потоку.

#### Синтаксис `listen()`:

```dart
StreamSubscription<T> listen(
  void Function(T event)? onData, {
  Function? onError,
  void Function()? onDone,
  bool? cancelOnError,
});
```

- **onData** — обробник для отримання даних з потоку (викликається кожного разу, коли надходить нова подія).
- **onError** — обробник для обробки помилок (опціонально).
- **onDone** — викликається, коли потік завершується (опціонально).
- **cancelOnError** — якщо `true`, підписка буде скасована у разі виникнення помилки.

### 1. **onData** — Обробник для отримання даних з потоку:

Кожного разу, коли в потік надходить нова подія, обробник `onData` буде викликано.

```dart
import 'dart:async';

void main() {
  StreamController<int> controller = StreamController<int>();

  // Підписка на потік з обробкою даних через onData
  controller.stream.listen((data) {
    print('Отримано дані: $data');
  });

  // Додаємо події
  controller.sink.add(1);
  controller.sink.add(2);
  controller.sink.add(3);

  // Закриваємо потік
  controller.close();
}
```

**Вивід:**

```dart
Отримано дані: 1
Отримано дані: 2
Отримано дані: 3
```

### 2. **onError** — Обробник для обробки помилок:

Обробник `onError` викликається, якщо в потік додається помилка через `sink.addError()`.

```dart
import 'dart:async';

void main() {
  StreamController<int> controller = StreamController<int>();

  // Підписка на потік з обробкою помилок через onError
  controller.stream.listen((data) {
    print('Отримано дані: $data');
  }, onError: (error) {
    print('Помилка: $error');
  });

  // Додаємо події та помилку
  controller.sink.add(1);
  controller.sink.addError('Сталася помилка!');
  controller.sink.add(2);

  // Закриваємо потік
  controller.close();
}
```

**Вивід:**

```dart
Отримано дані: 1
Помилка: Сталася помилка!
Отримано дані: 2
```

### 3. **onDone** — Викликається, коли потік завершується:

Обробник `onDone` викликається після того, як потік було закрито.

```dart
import 'dart:async';

void main() {
  StreamController<int> controller = StreamController<int>();

  // Підписка на потік з обробкою завершення через onDone
  controller.stream.listen((data) {
    print('Отримано дані: $data');
  }, onDone: () {
    print('Потік завершено');
  });

  // Додаємо події
  controller.sink.add(1);
  controller.sink.add(2);

  // Закриваємо потік
  controller.close();
}
```

**Вивід:**

```dart
Отримано дані: 1
Отримано дані: 2
Потік завершено
```

### 4. **cancelOnError** — Якщо `true`, підписка буде скасована у разі виникнення помилки:

Якщо встановити `cancelOnError` у значення `true`, то після виникнення помилки потік автоматично припинить роботу.

```dart
import 'dart:async';

void main() {
  StreamController<int> controller = StreamController<int>();

  // Підписка з автоматичним скасуванням у разі помилки
  controller.stream.listen((data) {
    print('Отримано дані: $data');
  }, onError: (error) {
    print('Помилка: $error');
  }, cancelOnError: true);

  // Додаємо події та помилку
  controller.sink.add(1);
  controller.sink.addError('Серйозна помилка!');
  controller.sink.add(2);

  // Закриваємо потік
  controller.close();
}
```

**Вивід:**

```dart
Отримано дані: 1
Помилка: Серйозна помилка!
```


> [!NOTE] Примітка
> Після помилки підписка автоматично скасовується, і подія з числом 2 більше не обробляється.

#### Приклад із обробкою помилок:

```dart
void main() {
  Stream<int> singleStream = Stream.fromIterable([1, 2, 3, 4, 5]);

  singleStream.listen(
    (data) {
      print('Отримано дані: $data');
    },
    onError: (error) {
      print('Помилка: $error');
    },
    onDone: () {
      print('Потік завершено');
    },
    cancelOnError: true, // Скасовує підписку при помилці
  );
}
```

### Помилки та завершення

- Якщо під час виконання потоку виникає помилка, метод `onError` дозволяє обробити цю помилку. Наприклад, це може бути помилка зчитування файлу або проблема з мережею.
- Метод `onDone` викликається, коли всі події передані і потік завершився успішно.

---
### Повторне використання потоку

Оскільки Single Subscription Stream призначений для одноразового використання, повторна підписка на нього після першого завершення не допускається. Якщо ви спробуєте зробити це, Dart згенерує помилку.

#### Приклад помилки при повторній підписці:

```dart
void main() {
  Stream<int> singleStream = Stream.fromIterable([1, 2, 3]);

  // Підписуємося на потік один раз
  singleStream.listen((data) {
    print('Перша підписка отримала дані: $data');
  });

  // Спроба підписатися ще раз
  singleStream.listen((data) {
    print('Друга підписка отримала дані: $data');
  }); // Виникне помилка: Bad state: Stream has already been listened to.
}
```

У цьому прикладі:

- Після першої підписки потік не може бути повторно використаний для іншої підписки, що викликає помилку.

---
### Створення Single Subscription Stream

Dart надає кілька способів створення Single Subscription Stream. Ось кілька методів:

**Stream.fromIterable()** — створює потік з колекції:

```dart
Stream<int> stream = Stream.fromIterable([1, 2, 3, 4, 5]);
```

**Stream.periodic()** — генерує події на основі таймера:

```dart
Stream<int> stream = Stream.periodic(Duration(seconds: 1), (count) => count);
```

**StreamController()** — створює кастомний потік з використанням контролера:

```dart
StreamController<int> controller = StreamController();
Stream<int> stream = controller.stream;

controller.add(1);
controller.add(2);
controller.add(3);

controller.close();
```


---

### Переваги та обмеження Single Subscription Stream

> [!advantages] Переваги:
> 
> - Прості у використанні для ситуацій, коли вам потрібно один раз передати дані або події.
> - Використовуються для обробки таких асинхронних дій, як HTTP-запити, доступ до файлів, де події мають бути оброблені один раз.

>[!limitations] Обмеження:
>
>- Після підписки ви не можете підписати інший слухач на той самий потік.
>- Якщо ви хочете мати багато слухачів або повторну підписку, вам слід використовувати **Broadcast Stream**.

---

> [!conclusion] Висновок
>
**Single Subscription Stream** — це базовий тип потоку в Dart, що дозволяє підписатися лише один раз для обробки асинхронних подій. Він ідеально підходить для сценаріїв, де потрібно одноразово обробити події або дані, такі як отримання результатів з HTTP-запитів або зчитування файлів.